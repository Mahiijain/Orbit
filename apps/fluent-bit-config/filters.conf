# Initialize shared state (MUST be first)
[FILTER]
    Name    lua
    Match   *
    Script  /scripts/control.lua
    Call    init

# Handle control messages
[FILTER]
    Name    lua
    Match   control
    Script  /scripts/control.lua
    Call    control_handler

# Filter actual log messages based on control state
[FILTER]
    Name    lua
    Match   logs.*
    Script  /scripts/control.lua
    Call    log_filter

# Add metadata to logs that pass through
[FILTER]
    Name    record_modifier
    Match   logs.*
    Record  collector fluent-bit
    Record  processed_by_control true

# Rename timestamp field
[FILTER]
    Name    modify
    Match   logs.*
    Rename  timestamp original_timestamp

# Extract nested details
[FILTER]
    Name    nest
    Match   logs.*
    Operation lift
    Nested_under details
    Add_prefix detail_